clc ; clear;
%%

% --- 1. Define Parameters ---
M_w = 0.5;   % Mass of one wheel
M_r = 1.0;   % Mass of robot body
m_b = 0.02;  % Mass of the ball
R = 0.05;    % Radius of the wheel
h = 0.1;     % Height of robot CoM from ball platform
r = 0.002;   % Radius of the ball
g = 9.81;    % Gravity
d = 0.03; 

% --- 2. Moments of Inertia ---
I_w = 0.5 * M_w * R^2;        % Inertia of one wheel (Note: Not used in M1, M2, M3)
I_r_com = (1/12) * M_r * (h^2 + d^2);       % body about its own COM
I_r = I_r_com + M_r * d^2;              % Inertia of robot body (parallel axis theorem)
I_b = 0.4 * m_b * r^2;      % Inertia of a solid sphere ball

% --- 3. Derived Parameters ---
l = h + r; % Height of ball CoM from wheel center


M1 = [(I_b/(r^2)) + m_b, m_b*l;
      m_b*l,            I_r + m_b*(l^2)];

% M2 = [[1,  1+(g*m_b)],
%       [1-(m_b*g), 1 - (M_r*d*g)-(m_b*g*l)]]
M2 = [1,             1 + (g*m_b);
      1 + (m_b*g), 1 + (M_r*d*g) + (m_b*g*l)];

% M3 = [[m_b*l],
%       [-m_b]]
M3 = [-m_b*l;
      -m_b];

% --- 5. Calculate A and B ---
% This is the numerically preferred method for A = inv(M1) * M2
A1 = M1 \ M2;

% This is the numerically preferred method for B = inv(M1) * M3
B1 = M1 \ M3;
%%

A = [0 1 0 0;... %[output:group:229a734b] %[output:60988226]
    A1(1,1) 0 A1(1,2) 0;... %[output:60988226]
    0 0 0 1;... %[output:60988226]
    A1(2,1) 0 A1(2,2) 0] %[output:group:229a734b] %[output:60988226]
B = -[0 ; B1(1); 0 ; B1(2)] %[output:06e878d2]
C = eye(4) %[output:717ff987]
D = zeros(4,1) %[output:052d9a1f]
%%
[num,den] = ss2tf(A,B,C,D) %[output:17d34675] %[output:9a8921cb]
%%
% --- 2. Create the individual Transfer Functions (TFs) ---

% H1(s) = Y1/U (from num row 1)
H1 = tf(num(1,:), den) %[output:8546a222]

% H2(s) = Y2/U (from num row 2)
H2 = tf(num(2,:), den) %[output:2e33cd79]

% H3(s) = Y3/U (from num row 3)
H3 = tf(num(3,:), den) %[output:0f51ec1d]

% H4(s) = Y4/U (from num row 4)
H4 = tf(num(4,:), den) %[output:88dfa763]
%%
sys = ss(A, B, C, D);
%%
rank(ctrb(A,B))
rank(obsv(A,C))
%%
% step input
% step(sys)
%%
% sine input 
% t = 0:0.001:5;
% u = sin(2*pi*t);
% lsim(sys,u,t)
%%
% ramp input 
% t = 0:0.01:10;
% u = t;         
% lsim(sys, u, t)
%%
OS = 10;      % percent overshoot
ts = 2;       % desired 2% settling time (seconds)

% correct 'a' and zeta
a = -log(OS/100);            % a = -ln(OS/100)  (natural log)
zeta = a / sqrt(a^2 + pi^2); % damping ratio

% natural frequency for 2% settling time approximation: ts â‰ˆ 4/(zeta*wn)
wn = 4 / (zeta * ts);

% desired complex pair (s^2 + 2*zeta*wn s + wn^2)

% p_c = roots([1, 2*zeta*wn, wn^2]);
% poles = [p_c;-0.02;-0.01];
poles = [ -500 ; -62 ; -2+2.7j ; -2-2.7j ];
K = place(A,B,poles) %[output:9826f55f]
% K = a 1x4 row vector

% Closed-loop A matrix
Acl = A - B*K;

% Check poles
disp('Closed-loop poles:') %[output:520652d0]
%%
sys_cl = ss(A - B*K, B, C-D, D);

figure;
step(sys_cl);
title('Closed-loop Step Response (Pole Placement)');
%%
% sine input 
t = 0:0.01:10;
u = sin(2*pi*t);
lsim(sys_cl,u,t,x0)

%%
x0 = [0.005;0;deg2rad(0);0] %[output:5c478aa7]
%%
x_inf = -(inv(A-B*K))*B
u_inf = -K*x_inf + 1

%[appendix]{"version":"1.0"}
%---
%[metadata:view]
%   data: {"layout":"onright"}
%---
%[output:60988226]
%   data: {"dataType":"matrix","outputData":{"columns":4,"name":"A","rows":4,"type":"double","value":[["0","1.0000","0","0"],["-8.1042","0","-5.1467","0"],["0","0","0","1.0000"],["601.4306","0","657.0140","0"]]}}
%---
%[output:06e878d2]
%   data: {"dataType":"matrix","outputData":{"columns":1,"name":"B","rows":4,"type":"double","value":[["0"],["-0.7015"],["0"],["10.6283"]]}}
%---
%[output:717ff987]
%   data: {"dataType":"matrix","outputData":{"columns":4,"name":"C","rows":4,"type":"double","value":[["1","0","0","0"],["0","1","0","0"],["0","0","1","0"],["0","0","0","1"]]}}
%---
%[output:052d9a1f]
%   data: {"dataType":"matrix","outputData":{"columns":1,"name":"D","rows":4,"type":"double","value":[["0"],["0"],["0"],["0"]]}}
%---
%[output:17d34675]
%   data: {"dataType":"matrix","outputData":{"columns":5,"name":"num","rows":4,"type":"double","value":[["0","0","-0.7015","0","406.1879"],["0","-0.7015","0","406.1879","0"],["0","0","10.6283","0.0000","-335.7635"],["0","10.6283","0","-335.7635","0"]]}}
%---
%[output:9a8921cb]
%   data: {"dataType":"matrix","outputData":{"columns":5,"exponent":"3","name":"den","rows":1,"type":"double","value":[["0.0010","0.0000","-0.6489","-0.0000","-2.2292"]]}}
%---
%[output:8546a222]
%   data: {"dataType":"text","outputData":{"text":"\nH1 =\n \n                  -0.7015 s^2 + 406.2\n  ----------------------------------------------------\n  s^4 + 2.953e-14 s^3 - 648.9 s^2 - 6.271e-13 s - 2229\n \nContinuous-time transfer function.\n<a href=\"matlab:disp(char([10 32 32 32 32 32 32 32 78 117 109 101 114 97 116 111 114 58 32 123 91 48 32 48 32 45 48 46 55 48 49 53 32 48 32 52 48 54 46 49 56 55 57 93 125 10 32 32 32 32 32 68 101 110 111 109 105 110 97 116 111 114 58 32 123 91 49 32 50 46 57 53 51 50 101 45 49 52 32 45 54 52 56 46 57 48 57 55 32 45 54 46 50 55 49 48 101 45 49 51 32 45 50 46 50 50 57 50 101 43 48 51 93 125 10 32 32 32 32 32 32 32 32 86 97 114 105 97 98 108 101 58 32 39 115 39 10 32 32 32 32 32 32 32 32 32 73 79 68 101 108 97 121 58 32 48 10 32 32 32 32 32 32 73 110 112 117 116 68 101 108 97 121 58 32 48 10 32 32 32 32 32 79 117 116 112 117 116 68 101 108 97 121 58 32 48 10 32 32 32 32 32 32 32 73 110 112 117 116 78 97 109 101 58 32 123 39 39 125 10 32 32 32 32 32 32 32 73 110 112 117 116 85 110 105 116 58 32 123 39 39 125 10 32 32 32 32 32 32 73 110 112 117 116 71 114 111 117 112 58 32 91 49 215 49 32 115 116 114 117 99 116 93 10 32 32 32 32 32 32 79 117 116 112 117 116 78 97 109 101 58 32 123 39 39 125 10 32 32 32 32 32 32 79 117 116 112 117 116 85 110 105 116 58 32 123 39 39 125 10 32 32 32 32 32 79 117 116 112 117 116 71 114 111 117 112 58 32 91 49 215 49 32 115 116 114 117 99 116 93 10 32 32 32 32 32 32 32 32 32 32 32 78 111 116 101 115 58 32 91 48 215 49 32 115 116 114 105 110 103 93 10 32 32 32 32 32 32 32 32 85 115 101 114 68 97 116 97 58 32 91 93 10 32 32 32 32 32 32 32 32 32 32 32 32 78 97 109 101 58 32 39 39 10 32 32 32 32 32 32 32 32 32 32 32 32 32 32 84 115 58 32 48 10 32 32 32 32 32 32 32 32 84 105 109 101 85 110 105 116 58 32 39 115 101 99 111 110 100 115 39 10 32 32 32 32 83 97 109 112 108 105 110 103 71 114 105 100 58 32 91 49 215 49 32 115 116 114 117 99 116 93 10]))\">Model Properties<\/a>\n","truncated":false}}
%---
%[output:2e33cd79]
%   data: {"dataType":"text","outputData":{"text":"\nH2 =\n \n                 -0.7015 s^3 + 406.2 s\n  ----------------------------------------------------\n  s^4 + 2.953e-14 s^3 - 648.9 s^2 - 6.271e-13 s - 2229\n \nContinuous-time transfer function.\n<a href=\"matlab:disp(char([10 32 32 32 32 32 32 32 78 117 109 101 114 97 116 111 114 58 32 123 91 48 32 45 48 46 55 48 49 53 32 48 32 52 48 54 46 49 56 55 57 32 48 93 125 10 32 32 32 32 32 68 101 110 111 109 105 110 97 116 111 114 58 32 123 91 49 32 50 46 57 53 51 50 101 45 49 52 32 45 54 52 56 46 57 48 57 55 32 45 54 46 50 55 49 48 101 45 49 51 32 45 50 46 50 50 57 50 101 43 48 51 93 125 10 32 32 32 32 32 32 32 32 86 97 114 105 97 98 108 101 58 32 39 115 39 10 32 32 32 32 32 32 32 32 32 73 79 68 101 108 97 121 58 32 48 10 32 32 32 32 32 32 73 110 112 117 116 68 101 108 97 121 58 32 48 10 32 32 32 32 32 79 117 116 112 117 116 68 101 108 97 121 58 32 48 10 32 32 32 32 32 32 32 73 110 112 117 116 78 97 109 101 58 32 123 39 39 125 10 32 32 32 32 32 32 32 73 110 112 117 116 85 110 105 116 58 32 123 39 39 125 10 32 32 32 32 32 32 73 110 112 117 116 71 114 111 117 112 58 32 91 49 215 49 32 115 116 114 117 99 116 93 10 32 32 32 32 32 32 79 117 116 112 117 116 78 97 109 101 58 32 123 39 39 125 10 32 32 32 32 32 32 79 117 116 112 117 116 85 110 105 116 58 32 123 39 39 125 10 32 32 32 32 32 79 117 116 112 117 116 71 114 111 117 112 58 32 91 49 215 49 32 115 116 114 117 99 116 93 10 32 32 32 32 32 32 32 32 32 32 32 78 111 116 101 115 58 32 91 48 215 49 32 115 116 114 105 110 103 93 10 32 32 32 32 32 32 32 32 85 115 101 114 68 97 116 97 58 32 91 93 10 32 32 32 32 32 32 32 32 32 32 32 32 78 97 109 101 58 32 39 39 10 32 32 32 32 32 32 32 32 32 32 32 32 32 32 84 115 58 32 48 10 32 32 32 32 32 32 32 32 84 105 109 101 85 110 105 116 58 32 39 115 101 99 111 110 100 115 39 10 32 32 32 32 83 97 109 112 108 105 110 103 71 114 105 100 58 32 91 49 215 49 32 115 116 114 117 99 116 93 10]))\">Model Properties<\/a>\n","truncated":false}}
%---
%[output:0f51ec1d]
%   data: {"dataType":"text","outputData":{"text":"\nH3 =\n \n             10.63 s^2 + 9.44e-15 s - 335.8\n  ----------------------------------------------------\n  s^4 + 2.953e-14 s^3 - 648.9 s^2 - 6.271e-13 s - 2229\n \nContinuous-time transfer function.\n<a href=\"matlab:disp(char([10 32 32 32 32 32 32 32 78 117 109 101 114 97 116 111 114 58 32 123 91 48 32 48 32 49 48 46 54 50 56 51 32 57 46 52 51 57 56 101 45 49 53 32 45 51 51 53 46 55 54 51 53 93 125 10 32 32 32 32 32 68 101 110 111 109 105 110 97 116 111 114 58 32 123 91 49 32 50 46 57 53 51 50 101 45 49 52 32 45 54 52 56 46 57 48 57 55 32 45 54 46 50 55 49 48 101 45 49 51 32 45 50 46 50 50 57 50 101 43 48 51 93 125 10 32 32 32 32 32 32 32 32 86 97 114 105 97 98 108 101 58 32 39 115 39 10 32 32 32 32 32 32 32 32 32 73 79 68 101 108 97 121 58 32 48 10 32 32 32 32 32 32 73 110 112 117 116 68 101 108 97 121 58 32 48 10 32 32 32 32 32 79 117 116 112 117 116 68 101 108 97 121 58 32 48 10 32 32 32 32 32 32 32 73 110 112 117 116 78 97 109 101 58 32 123 39 39 125 10 32 32 32 32 32 32 32 73 110 112 117 116 85 110 105 116 58 32 123 39 39 125 10 32 32 32 32 32 32 73 110 112 117 116 71 114 111 117 112 58 32 91 49 215 49 32 115 116 114 117 99 116 93 10 32 32 32 32 32 32 79 117 116 112 117 116 78 97 109 101 58 32 123 39 39 125 10 32 32 32 32 32 32 79 117 116 112 117 116 85 110 105 116 58 32 123 39 39 125 10 32 32 32 32 32 79 117 116 112 117 116 71 114 111 117 112 58 32 91 49 215 49 32 115 116 114 117 99 116 93 10 32 32 32 32 32 32 32 32 32 32 32 78 111 116 101 115 58 32 91 48 215 49 32 115 116 114 105 110 103 93 10 32 32 32 32 32 32 32 32 85 115 101 114 68 97 116 97 58 32 91 93 10 32 32 32 32 32 32 32 32 32 32 32 32 78 97 109 101 58 32 39 39 10 32 32 32 32 32 32 32 32 32 32 32 32 32 32 84 115 58 32 48 10 32 32 32 32 32 32 32 32 84 105 109 101 85 110 105 116 58 32 39 115 101 99 111 110 100 115 39 10 32 32 32 32 83 97 109 112 108 105 110 103 71 114 105 100 58 32 91 49 215 49 32 115 116 114 117 99 116 93 10]))\">Model Properties<\/a>\n","truncated":false}}
%---
%[output:88dfa763]
%   data: {"dataType":"text","outputData":{"text":"\nH4 =\n \n                  10.63 s^3 - 335.8 s\n  ----------------------------------------------------\n  s^4 + 2.953e-14 s^3 - 648.9 s^2 - 6.271e-13 s - 2229\n \nContinuous-time transfer function.\n<a href=\"matlab:disp(char([10 32 32 32 32 32 32 32 78 117 109 101 114 97 116 111 114 58 32 123 91 48 32 49 48 46 54 50 56 51 32 48 32 45 51 51 53 46 55 54 51 53 32 48 93 125 10 32 32 32 32 32 68 101 110 111 109 105 110 97 116 111 114 58 32 123 91 49 32 50 46 57 53 51 50 101 45 49 52 32 45 54 52 56 46 57 48 57 55 32 45 54 46 50 55 49 48 101 45 49 51 32 45 50 46 50 50 57 50 101 43 48 51 93 125 10 32 32 32 32 32 32 32 32 86 97 114 105 97 98 108 101 58 32 39 115 39 10 32 32 32 32 32 32 32 32 32 73 79 68 101 108 97 121 58 32 48 10 32 32 32 32 32 32 73 110 112 117 116 68 101 108 97 121 58 32 48 10 32 32 32 32 32 79 117 116 112 117 116 68 101 108 97 121 58 32 48 10 32 32 32 32 32 32 32 73 110 112 117 116 78 97 109 101 58 32 123 39 39 125 10 32 32 32 32 32 32 32 73 110 112 117 116 85 110 105 116 58 32 123 39 39 125 10 32 32 32 32 32 32 73 110 112 117 116 71 114 111 117 112 58 32 91 49 215 49 32 115 116 114 117 99 116 93 10 32 32 32 32 32 32 79 117 116 112 117 116 78 97 109 101 58 32 123 39 39 125 10 32 32 32 32 32 32 79 117 116 112 117 116 85 110 105 116 58 32 123 39 39 125 10 32 32 32 32 32 79 117 116 112 117 116 71 114 111 117 112 58 32 91 49 215 49 32 115 116 114 117 99 116 93 10 32 32 32 32 32 32 32 32 32 32 32 78 111 116 101 115 58 32 91 48 215 49 32 115 116 114 105 110 103 93 10 32 32 32 32 32 32 32 32 85 115 101 114 68 97 116 97 58 32 91 93 10 32 32 32 32 32 32 32 32 32 32 32 32 78 97 109 101 58 32 39 39 10 32 32 32 32 32 32 32 32 32 32 32 32 32 32 84 115 58 32 48 10 32 32 32 32 32 32 32 32 84 105 109 101 85 110 105 116 58 32 39 115 101 99 111 110 100 115 39 10 32 32 32 32 83 97 109 112 108 105 110 103 71 114 105 100 58 32 91 49 215 49 32 115 116 114 117 99 116 93 10]))\">Model Properties<\/a>\n","truncated":false}}
%---
%[output:9826f55f]
%   data: {"dataType":"matrix","outputData":{"columns":4,"exponent":"3","name":"K","rows":1,"type":"double","value":[["3.7066","0.3860","3.4350","0.0787"]]}}
%---
%[output:520652d0]
%   data: {"dataType":"text","outputData":{"text":"Closed-loop poles:\n","truncated":false}}
%---
%[output:5c478aa7]
%   data: {"dataType":"matrix","outputData":{"columns":1,"name":"x0","rows":4,"type":"double","value":[["0.0050"],["0"],["0"],["0"]]}}
%---
